generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum ProjectStatus {
  ACTIVE
  PAUSED
  ARCHIVED
}

enum BillingMode {
  FIXED_TOTAL
  RECURRING_PERIOD
  HOURLY
}

enum RecurringPeriodType {
  MONTHLY
  WEEKLY
  CUSTOM
}

enum TodoPriority {
  LOW
  MEDIUM
  HIGH
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  CANCELLED
}

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String
  name         String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  projects    Project[]
  timeEntries TimeEntry[]
  invoices    Invoice[]
  payments    Payment[]

  @@index([email])
  @@index([createdAt])
}

model Project {
  id                  String               @id @default(uuid())
  userId              String
  name                String
  clientName          String?
  description         String?
  status              ProjectStatus        @default(ACTIVE)
  billingMode         BillingMode
  fixedTotalAmount    Decimal?             @db.Decimal(12, 2)
  recurringAmount     Decimal?             @db.Decimal(12, 2)
  recurringPeriodType RecurringPeriodType?
  hourlyRate          Decimal?             @db.Decimal(12, 2)
  currency            String               @default("EUR")
  startDate           DateTime?            @db.Date
  endDate             DateTime?            @db.Date
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt

  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  timeEntries TimeEntry[]
  todos       ProjectTodo[]
  invoices    Invoice[]
  payments    Payment[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model TimeEntry {
  id                 String    @id @default(uuid())
  projectId          String
  userId             String
  startedAt          DateTime
  endedAt            DateTime?
  durationMinutes    Int?
  note               String?
  billingPeriodStart DateTime? @db.Date
  billingPeriodEnd   DateTime? @db.Date
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([userId])
  @@index([startedAt])
  @@index([createdAt])
}

model ProjectTodo {
  id          String       @id @default(uuid())
  projectId   String
  title       String
  description String?
  priority    TodoPriority @default(MEDIUM)
  dueDate     DateTime?    @db.Date
  completed   Boolean      @default(false)
  completedAt DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([completed])
  @@index([dueDate])
  @@index([createdAt])
}

model Invoice {
  id             String        @id @default(uuid())
  userId         String
  projectId      String?
  issueDate      DateTime      @db.Date
  dueDate        DateTime?     @db.Date
  amount         Decimal       @db.Decimal(12, 2)
  currency       String        @default("EUR")
  status         InvoiceStatus @default(DRAFT)
  externalNumber String?
  notes          String?
  periodStart    DateTime?     @db.Date
  periodEnd      DateTime?     @db.Date
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  project  Project?  @relation(fields: [projectId], references: [id], onDelete: SetNull)
  payments Payment[]

  @@index([userId])
  @@index([projectId])
  @@index([status])
  @@index([issueDate])
  @@index([createdAt])
}

model Payment {
  id          String   @id @default(uuid())
  invoiceId   String
  userId      String
  projectId   String?
  paymentDate DateTime @db.Date
  amount      Decimal  @db.Decimal(12, 2)
  currency    String   @default("EUR")
  method      String?
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  invoice Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@index([invoiceId])
  @@index([userId])
  @@index([projectId])
  @@index([paymentDate])
  @@index([createdAt])
}

